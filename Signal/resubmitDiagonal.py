# Resubmit diagonal proc x cat signal fit
import os, re, sys
import glob
from optparse import OptionParser

parallelProc = {
  "RECO_0J_PTH_0_10_Tag0":"GG2H_0J_PTH_0_10,3",
  "RECO_0J_PTH_0_10_Tag1":"GG2H_0J_PTH_0_10,3",
  "RECO_0J_PTH_0_10_Tag2":"GG2H_0J_PTH_0_10,3",
  "RECO_0J_PTH_GT10_Tag0":"GG2H_0J_PTH_GT10,3",
  "RECO_0J_PTH_GT10_Tag1":"GG2H_0J_PTH_GT10,3",
  "RECO_0J_PTH_GT10_Tag2":"GG2H_0J_PTH_GT10,3",
  "RECO_1J_PTH_0_60_Tag0":"GG2H_1J_PTH_0_60,3",
  "RECO_1J_PTH_0_60_Tag1":"GG2H_1J_PTH_0_60,3",
  "RECO_1J_PTH_0_60_Tag2":"GG2H_1J_PTH_0_60,3",
  "RECO_1J_PTH_120_200_Tag0":"GG2H_1J_PTH_120_200,3",
  "RECO_1J_PTH_120_200_Tag1":"GG2H_1J_PTH_120_200,3",
  "RECO_1J_PTH_120_200_Tag2":"GG2H_1J_PTH_120_200,3",
  "RECO_1J_PTH_60_120_Tag0":"GG2H_1J_PTH_60_120,3",
  "RECO_1J_PTH_60_120_Tag1":"GG2H_1J_PTH_60_120,3",
  "RECO_1J_PTH_60_120_Tag2":"GG2H_1J_PTH_60_120,3",
  "RECO_GE2J_PTH_0_60_Tag0":"GG2H_GE2J_MJJ_0_350_PTH_0_60,3",
  "RECO_GE2J_PTH_0_60_Tag1":"GG2H_GE2J_MJJ_0_350_PTH_0_60,2",
  "RECO_GE2J_PTH_0_60_Tag2":"GG2H_GE2J_MJJ_0_350_PTH_0_60,2",
  "RECO_GE2J_PTH_120_200_Tag0":"GG2H_GE2J_MJJ_0_350_PTH_120_200,2",
  "RECO_GE2J_PTH_120_200_Tag1":"GG2H_GE2J_MJJ_0_350_PTH_120_200,2",
  "RECO_GE2J_PTH_120_200_Tag2":"GG2H_GE2J_MJJ_0_350_PTH_120_200,2",
  "RECO_GE2J_PTH_60_120_Tag0":"GG2H_GE2J_MJJ_0_350_PTH_60_120,2",
  "RECO_GE2J_PTH_60_120_Tag1":"GG2H_GE2J_MJJ_0_350_PTH_60_120,2",
  "RECO_GE2J_PTH_60_120_Tag2":"GG2H_GE2J_MJJ_0_350_PTH_60_120,2",
  "RECO_PTH_200_300_Tag0":"GG2H_PTH_200_300,2",
  "RECO_PTH_200_300_Tag1":"GG2H_PTH_200_300,2",
  "RECO_PTH_300_450_Tag0":"GG2H_PTH_300_450,2",
  "RECO_PTH_300_450_Tag1":"GG2H_PTH_300_450,1",
  "RECO_PTH_450_650_Tag0":"GG2H_PTH_450_650,1",
  "RECO_PTH_GT650_Tag0":"GG2H_PTH_GT650,1",
  "RECO_THQ_LEP":"THQ,2",
  "RECO_TTH_HAD_PTH_0_60_Tag0":"TTH_PTH_0_60,1",
  "RECO_TTH_HAD_PTH_0_60_Tag1":"TTH_PTH_0_60,1",
  "RECO_TTH_HAD_PTH_0_60_Tag2":"TTH_PTH_0_60,1",
  "RECO_TTH_HAD_PTH_0_60_Tag3":"TTH_PTH_0_60,1",
  "RECO_TTH_HAD_PTH_120_200_Tag0":"TTH_PTH_120_200,1",
  "RECO_TTH_HAD_PTH_120_200_Tag1":"TTH_PTH_120_200,1",
  "RECO_TTH_HAD_PTH_120_200_Tag2":"TTH_PTH_120_200,1",
  "RECO_TTH_HAD_PTH_120_200_Tag3":"TTH_PTH_120_200,1",
  "RECO_TTH_HAD_PTH_60_120_Tag0":"TTH_PTH_60_120,1",
  "RECO_TTH_HAD_PTH_60_120_Tag1":"TTH_PTH_60_120,1",
  "RECO_TTH_HAD_PTH_60_120_Tag2":"TTH_PTH_60_120,1",
  "RECO_TTH_HAD_PTH_60_120_Tag3":"TTH_PTH_60_120,1",
  "RECO_TTH_HAD_PTH_GT200_Tag0":"TTH_PTH_200_300,1",
  "RECO_TTH_HAD_PTH_GT200_Tag1":"TTH_PTH_200_300,1",
  "RECO_TTH_HAD_PTH_GT200_Tag2":"TTH_PTH_200_300,1",
  "RECO_TTH_HAD_PTH_GT200_Tag3":"TTH_PTH_200_300,1",
  "RECO_TTH_LEP_PTH_0_60_Tag0":"TTH_PTH_0_60,1",
  "RECO_TTH_LEP_PTH_0_60_Tag1":"TTH_PTH_0_60,1",
  "RECO_TTH_LEP_PTH_0_60_Tag2":"TTH_PTH_0_60,1",
  "RECO_TTH_LEP_PTH_0_60_Tag3":"TTH_PTH_0_60,1",
  "RECO_TTH_LEP_PTH_120_200_Tag0":"TTH_PTH_120_200,1",
  "RECO_TTH_LEP_PTH_120_200_Tag1":"TTH_PTH_120_200,1",
  "RECO_TTH_LEP_PTH_60_120_Tag0":"TTH_PTH_60_120,1",
  "RECO_TTH_LEP_PTH_60_120_Tag1":"TTH_PTH_60_120,1",
  "RECO_TTH_LEP_PTH_GT200_Tag0":"TTH_PTH_200_300,1",
  "RECO_TTH_LEP_PTH_GT200_Tag1":"TTH_PTH_200_300,1",
  "RECO_VBFLIKEGGH_Tag0":"GG2H_GE2J_MJJ_350_700_PTH_0_200_PTHJJ_GT25,1",
  "RECO_VBFLIKEGGH_Tag1":"GG2H_GE2J_MJJ_350_700_PTH_0_200_PTHJJ_GT25,1",
  "RECO_VBFTOPO_BSM_Tag0":"VBF_GE2J_MJJ_GT350_PTH_GT200,2",
  "RECO_VBFTOPO_BSM_Tag1":"VBF_GE2J_MJJ_GT350_PTH_GT200,2",
  "RECO_VBFTOPO_JET3VETO_HIGHMJJ_Tag0":"VBF_GE2J_MJJ_GT700_PTH_0_200_PTHJJ_0_25,2",
  "RECO_VBFTOPO_JET3VETO_HIGHMJJ_Tag1":"VBF_GE2J_MJJ_GT700_PTH_0_200_PTHJJ_0_25,2",
  "RECO_VBFTOPO_JET3VETO_LOWMJJ_Tag0":"VBF_GE2J_MJJ_350_700_PTH_0_200_PTHJJ_0_25,2",
  "RECO_VBFTOPO_JET3VETO_LOWMJJ_Tag1":"VBF_GE2J_MJJ_350_700_PTH_0_200_PTHJJ_0_25,2",
  "RECO_VBFTOPO_JET3_HIGHMJJ_Tag0":"VBF_GE2J_MJJ_GT700_PTH_0_200_PTHJJ_GT25,2",
  "RECO_VBFTOPO_JET3_HIGHMJJ_Tag1":"VBF_GE2J_MJJ_GT700_PTH_0_200_PTHJJ_GT25,2",
  "RECO_VBFTOPO_JET3_LOWMJJ_Tag0":"VBF_GE2J_MJJ_350_700_PTH_0_200_PTHJJ_GT25,1",
  "RECO_VBFTOPO_JET3_LOWMJJ_Tag1":"VBF_GE2J_MJJ_350_700_PTH_0_200_PTHJJ_GT25,2",
  "RECO_VBFTOPO_VHHAD_Tag0":"WH2HQQ_GE2J_MJJ_60_120,2",
  "RECO_VBFTOPO_VHHAD_Tag1":"WH2HQQ_GE2J_MJJ_60_120,2",
  "RECO_VH_MET_Tag0":"QQ2HLL_PTV_150_250_0J,1",
  "RECO_VH_MET_Tag1":"QQ2HLL_PTV_75_150,1",
  "RECO_WH_LEP_HIGH_Tag0":"QQ2HLNU_PTV_75_150,3",
  "RECO_WH_LEP_HIGH_Tag1":"QQ2HLNU_PTV_75_150,2",
  "RECO_WH_LEP_HIGH_Tag2":"QQ2HLNU_PTV_75_150,1",
  "RECO_WH_LEP_LOW_Tag0":"QQ2HLNU_PTV_0_75,1",
  "RECO_WH_LEP_LOW_Tag1":"QQ2HLNU_PTV_0_75,2",
  "RECO_WH_LEP_LOW_Tag2":"QQ2HLNU_PTV_0_75,1",
  "RECO_ZH_LEP_Tag0":"QQ2HLL_PTV_75_150,1",
  "RECO_ZH_LEP_Tag1":"QQ2HLL_PTV_75_150,1"
}

def get_options():
  parser = OptionParser()
  parser.add_option("--ext", dest='ext', default='', help="Extension")
  return parser.parse_args()
(opt,args) = get_options()

# Glob log files from initial signal fit
logFiles = glob.glob("outdir_%s/sigfit/SignalFitJobs/*.log"%opt.ext)
resubmitFiles = []
# Loop over log files
for lf in logFiles:
  with open(lf,"r") as fin:
    for line in fin:
      if("proc:" in line)&(" - cat:" in line):
	for cat,proc in parallelProc.iteritems():
          proc = proc.split(",")[0]
	  if "proc:%s - cat:%s"%(proc,cat) in line: resubmitFiles.append( re.sub(".log","",lf) )

# Resubmit files to batch
for f in resubmitFiles: os.system("qsub -q hep.q -l h_rt=0:20:0 %s"%f)
